# 论一次登录页所经历的坑及所学

## 引言
> 在一家家政公司曾经有过开发商城项目的经历，按照UI和领导要求完成个人中心模块后，接口也联调完了，测试也通过了；突然有那么一天，leader 跟我说，个人中心的登录模块需要重做，什么个鬼，都已经交付完成了，突然要重做，问了个源由，原来该公司已经提供 SSO 单点登录系统，商场也要使用这套登录系统，方便以后的大数据分析，好吧，说做就做吧。反正坑也留下了！

## 踩坑

原先以为只要把登录页面换成公司单点登录页面就可以，没想到这期间遇到各种坑，由于前后端都不了解这套SSO单点登录系统原理（开发此套系统的已离职，在职的前后端也不清楚，商城已经前后端分离（vue 全家桶），其他部门还是旧的开发模式），后台一直无法获取到登录后的用户信息，一些需要用户信息的页面，自然而然无法显示出正常的数据。   
就这样，跟后台开发人员在一片骂声中开启了脱坑之路，由于是单点登录系统，脱坑也存在很大阻碍，在新的系统一直未找到问题所在，然后我们转换思路去看原先旧的商城系统，最后才找到其工作原理，利用 cookie 来保存 token 存放用户数据，每次用户发起数据请求， cookie 放在 header 请求头里，传给后台，后台解析 token 数据获取用户数据，实现互踢，传值功能。  
知道单点登录系统的实现原理后，后台还是无法正常获取到  cookie 值，这下代志大条了，之前一直把锅丢给后台，现在反噬到前端，锅一下子又回到前端这边，当时的我就想估计是某个参数忘记了，后面在购物车不断请求，控制台一直提示一条跨域的信息，这下问题终于可以解决



## 脱坑之路，理解公司单点登录工作原理
### 1. 工作原理
- 第一次用户登录的时候，输入用户名和密码信息，服务端接收后进行用户认证。
- 服务端通过验证后，生成一个token以cookie的形式放在http的response header中一起返回给客户端。
- 浏览器根据是否设置cookie的过期时间判断该cookie是会话cookie还是永久cookie，并将cookie存储在不同的位置。
- 下次进行http请求时，请求头中会自动携带存储的cookie。
- 服务端根据请求头中的cookie里面的token确认该用户的身份信息。
### 2. cookie
 在计算机术语中指服务端存放在客户端的一段数据。这段数据在客户端每次进行http请求时会自动加在http请求报文中的header上；服务端在响应时，可以对cookie进行设置，并将cookie加入到http响应报文header中  
 解决方案：  
 - 前端：由于使用 vue-axios，在 import axios 实例时，加入此参数可以向后台跨域传送 cookie
 ```
axios.defaults.withCredentials = true
 ```

### 3. 跨域
 在这边遇到跨域问题，是由于请求的域名跟商城的域名不同所引起的， 跨域是由同源安全策略限制而发生的，
 所谓同源是指"协议+域名+端口"三者相同，其中一个不同就会引起跨域  
 （1）协议不同：http://www.baidu.com 与https://www.baidu.com  
（2）域名不同：http://www.baidu.com 与http://www.google.com  
（3）端口号不同： http://www.baidu.com:8080 与http://www.baidu.com:8000

 - 后端：在response header里面添加配置项  
  ```
 "Access-Control-Allow-Credentials", "true"   
"Access-Control-Allow-Origin", "yourdomain"
```

## 总结
1. 暴露本人的一些知识盲区，如果对 cookie 及 http 协议比较熟悉的人，都能很快看出其工作原理以及问题所在
2. 部门之间的沟通协调出现问题，一但有 bug ，经常性扯皮，相互推诿，推锅